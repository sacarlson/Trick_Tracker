<!DOCTYPE html>
<html>
<head>
    <title>Real-Time Map</title>
    <meta charset="utf-8" />
    <meta name="keywords" content="real-time, Map, Track, parties, party, Events, GPS, Photos, way points, mark, find friends ">

    <meta name="description" content="A web app real-time updating Map and tracker database to find girls for hire nearby, advertise party locations and track people using your mobile phones Map, GPS and Camera features. ">

    <link rel="stylesheet" href="w3.css">
    <link rel="stylesheet" href="leaflet.css" />
        
    <style type="text/css">
		#map { width: 700px; height: 433px; }
		.fullscreen-icon { background-image: url(icon-fullscreen.png); }
		/* on selector per rule as explained here : http://www.sitepoint.com/html5-full-screen-api/ */
		#map:-webkit-full-screen { width: 100% ; height: 100% ; z-index: 99999; }
		#map:-moz-full-screen { width: 100% ; height: 100% ; z-index: 99999; }
		#map:full-screen { width: 100% ; height: 100% ; z-index: 99999; }
		.leaflet-pseudo-fullscreen { position: fixed ; width: 100% ; height: 100% ; top: 0px ; left: 0px ; z-index: 99999; }
  .box {
     height: 240px;
     margin: 30px; 
  }

 ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
    overflow: hidden;
    background-color: #333;
 }

li {
    float: left;
}

li a {
    display: block;
    color: white;
    text-align: center;
    padding: 14px 16px;
    text-decoration: none;
}

li a:hover:not(.active) {
    background-color: #111;
}

.active {
    background-color: #4CAF50;
}

li {
    border-right: 3px solid #bbb;
    border-bottom: 3px solid #bbb;
}

a {
  font-size: calc(1.5vw + 1.5vh + 1.5vmin);
 }



	</style>
</head>
<body>
    <div class="box">
  <ul>
  <li><a href="send.html">Send Cords</a></li>
  <li><a href="change_icon.html">Change Icon</a></li>
  <li><a href="config.html">Config</a></li>
  <li><a href="./shoot/index.html">Shoot Pic</a></li>
  <li><span id="gallery_path"></span></li>
  <li><a href="./wiki/doku.php">Wiki</a></li>
  <li><a href="chat.html">Real Time Chat</a></li>
</ul>
  <h1><span id="site_hostname"></span> Map</h1>
</div>
    <div id="map" style="width: 100%; height: 1200px"></div>

  
        <script src="leaflet.js"></script>
	<script src="Control.FullScreen.js"></script>   

    <script>

    function dropDown() {
      document.getElementById("myDropdown").classList.toggle("show");
    }

  window.addEventListener("load", function(event) {
    console.log("window loaded");
    var url ;

    var http = new XMLHttpRequest();
    var markers = [];
    var markers_data = [];
    var lines = [];
    var myLines = [];
    var last_marker_count = 0;
    var last_data_marker_count = 0;
    var url_position = 0;
    var timestamp = Math.floor(Date.now() / 1000);
    
    var params = {};
    get_config();
    var json_param = window.location.href.match(/\?json=(.*)/);
    if (json_param != null) {
      json_param = unescape(json_param[1]);
      var params2 = JSON.parse(json_param);
      //params = merge_options(params2,params);
      params = merge_options(params,params2);
    }
    
    console.log("params");
    console.log(params);
    
   var http = new XMLHttpRequest();
   var last_sent_cords_timestamp = 0;

   //var site_hostname = get_site_hostname();
   document.getElementById("site_hostname").innerHTML= get_site_hostname();
   getLocation();

  

  var scottyIcon = L.icon({
    iconUrl: 'images/scotty_map_icon75x75.png',    
    iconSize:     [75, 75], // size of the icon
    iconAnchor:   [37, 75], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -77], // point from which the popup should open relative to the iconAnchor
  });
 

  var cop_runingIcon = L.icon({
    iconUrl: 'images/running_cop_50x61.png',
    iconSize:     [50, 61], // size of the icon
    iconAnchor:   [25, 61], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -76] // point from which the popup should open relative to the iconAnchor
  });

  var copIcon = L.icon({
    iconUrl: 'images/police_standing_25x94.png',
    iconSize:     [25, 94], // size of the icon
    iconAnchor:   [17, 61], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -96] // point from which the popup should open relative to the iconAnchor
  });

  var johnIcon = L.icon({
    iconUrl: 'images/man_with_money_49x61.png',
    iconSize:     [49, 61], // size of the icon
    iconAnchor:   [25, 61], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -64] // point from which the popup should open relative to the iconAnchor
  });

  var fat_girlIcon = L.icon({
    iconUrl: 'images/fat_girl_47x60.png',
    iconSize:     [47, 60], // size of the icon
    iconAnchor:   [25, 60], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -65] // point from which the popup should open relative to the iconAnchor
  });

  var police_truckIcon = L.icon({
    iconUrl: 'images/police_truck_60x23.png',
    iconSize:     [60, 23], // size of the icon
    iconAnchor:   [30, 23], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -25] // point from which the popup should open relative to the iconAnchor
  });

  var girlIcon = L.icon({
    iconUrl: 'images/nice_girl_21x62.png',
    iconSize:     [21, 62], // size of the icon
    iconAnchor:   [10, 62], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -65] // point from which the popup should open relative to the iconAnchor
  });

  var sexyIcon = L.icon({
    iconUrl: 'images/sexy_girl_20x60.png',
    iconSize:     [20, 60], // size of the icon
    iconAnchor:   [10, 60], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -65] // point from which the popup should open relative to the iconAnchor
  });

  var ihereIcon = L.icon({
    iconUrl: 'images/Im_here45x60.png',    
    iconSize:     [45, 60], // size of the icon
    iconAnchor:   [22, 60], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -65], // point from which the popup should open relative to the iconAnchor
  });

  var skiny_girlIcon = L.icon({
    iconUrl: 'images/skiny_no_tits_18x60.png',    
    iconSize:     [18, 60], // size of the icon
    iconAnchor:   [9, 60], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -65], // point from which the popup should open relative to the iconAnchor
  });

  var lady_boyIcon = L.icon({
    iconUrl: 'images/lady_boy_39x61.png',    
    iconSize:     [39, 61], // size of the icon
    iconAnchor:   [19, 61], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -65], // point from which the popup should open relative to the iconAnchor
  });

  var short_girlIcon = L.icon({
    iconUrl: 'images/short_girl_18x40.png',    
    iconSize:     [18, 40], // size of the icon
    iconAnchor:   [9, 40], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -45], // point from which the popup should open relative to the iconAnchor
  });

  // icon 13
  var partyIcon = L.icon({
    iconUrl: 'images/beer_party60x48.png',    
    iconSize:     [60, 48], // size of the icon
    iconAnchor:   [30, 24], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -50], // point from which the popup should open relative to the iconAnchor
  });

  // icon 14
  var eatingIcon = L.icon({
    iconUrl: 'images/eat_food47x60.png',    
    iconSize:     [47, 60], // size of the icon
    iconAnchor:   [23, 24], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -50], // point from which the popup should open relative to the iconAnchor
  });

  //icon 15
  var weedIcon = L.icon({
    iconUrl: 'images/weed_icon41x61.png',    
    iconSize:     [41, 61], // size of the icon
    iconAnchor:   [20, 61], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -62], // point from which the popup should open relative to the iconAnchor
  });

  //icon 16
  var cameraIcon = L.icon({
    iconUrl: 'images/camera30x24.png',    
    iconSize:     [30, 24], // size of the icon
    iconAnchor:   [15, 25], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -25], // point from which the popup should open relative to the iconAnchor
  });

  //17
  var bicycleIcon = L.icon({
    iconUrl: 'images/biker50x44.png',    
    iconSize:     [50, 44], // size of the icon
    iconAnchor:   [25, 44], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -44], // point from which the popup should open relative to the iconAnchor
  });

  //18
  var hikeIcon = L.icon({
    iconUrl: 'images/hiker33x52.png',    
    iconSize:     [33, 52], // size of the icon
    iconAnchor:   [16, 52], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -52], // point from which the popup should open relative to the iconAnchor
  });

  //19
  var rollerbladeIcon = L.icon({
    iconUrl: 'images/rollerblade36x50.png',    
    iconSize:     [36, 50], // size of the icon
    iconAnchor:   [18, 50], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -50], // point from which the popup should open relative to the iconAnchor
  });

  //20
  var skateboardIcon = L.icon({
    iconUrl: 'images/skateboard40x50.png',    
    iconSize:     [36, 50], // size of the icon
    iconAnchor:   [18, 50], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -50], // point from which the popup should open relative to the iconAnchor
  });

  //21
  var motorbikeIcon = L.icon({
    iconUrl: 'images/motor_bike50x50.png',    
    iconSize:     [50, 50], // size of the icon
    iconAnchor:   [25, 50], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -50], // point from which the popup should open relative to the iconAnchor
  });

  //22
  var harlybikeIcon = L.icon({
    iconUrl: 'images/harly_motorbike52x32.png',    
    iconSize:     [52, 32], // size of the icon
    iconAnchor:   [25, 32], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -32], // point from which the popup should open relative to the iconAnchor
  });

  //23
  var kitesurfIcon = L.icon({
    iconUrl: 'images/kitesurf50x52.png',    
    iconSize:     [50, 52], // size of the icon
    iconAnchor:   [25, 52], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -52], // point from which the popup should open relative to the iconAnchor
  });

  //24
  var windsurfIcon = L.icon({
    iconUrl: 'images/windsurf50x50.png',    
    iconSize:     [50, 50], // size of the icon
    iconAnchor:   [25, 50], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -50], // point from which the popup should open relative to the iconAnchor
  });

  //25
  var motorboatIcon = L.icon({
    iconUrl: 'images/luxury-yacht-boat50x22.png',    
    iconSize:     [50, 22], // size of the icon
    iconAnchor:   [25, 22], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -22], // point from which the popup should open relative to the iconAnchor
  });

  //26
  var sailboatIcon = L.icon({
    iconUrl: 'images/sailor-boat50x50.png',    
    iconSize:     [50, 50], // size of the icon
    iconAnchor:   [25, 50], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -50], // point from which the popup should open relative to the iconAnchor
  });

  //27
  var hangglideIcon = L.icon({
    iconUrl: 'images/hang_glider50x45.png',    
    iconSize:     [50, 45], // size of the icon
    iconAnchor:   [25, 45], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -45], // point from which the popup should open relative to the iconAnchor
  });

  //28
  var carIcon = L.icon({
    iconUrl: 'images/car50x23.png',    
    iconSize:     [50, 23], // size of the icon
    iconAnchor:   [25, 23], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -23], // point from which the popup should open relative to the iconAnchor
  });

  //29
  var pickupIcon = L.icon({
    iconUrl: 'images/pickup_truck52x20.png',    
    iconSize:     [52, 20], // size of the icon
    iconAnchor:   [25, 20], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -20], // point from which the popup should open relative to the iconAnchor
  });

  //30
  var bigtruckIcon = L.icon({
    iconUrl: 'images/transportation-truck50x22.png',    
    iconSize:     [50, 22], // size of the icon
    iconAnchor:   [25, 22], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -22], // point from which the popup should open relative to the iconAnchor
  });

  //31
  var trainIcon = L.icon({
    iconUrl: 'images/train33x50.png',    
    iconSize:     [33, 50], // size of the icon
    iconAnchor:   [16, 50], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -50], // point from which the popup should open relative to the iconAnchor
  });

  //32
  var remoteIcon = L.icon({
    iconUrl: 'images/remotecon41x50.png',    
    iconSize:     [41, 50], // size of the icon
    iconAnchor:   [20, 50], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -50], // point from which the popup should open relative to the iconAnchor
  });

   //33
  var musicIcon = L.icon({
    iconUrl: 'images/music_band50x50.png',    
    iconSize:     [50, 50], // size of the icon
    iconAnchor:   [25, 50], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -50], // point from which the popup should open relative to the iconAnchor
  });
	
   //34
  var chessIcon = L.icon({
    iconUrl: 'images/chess50x50.png',    
    iconSize:     [50, 50], // size of the icon
    iconAnchor:   [25, 50], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -50], // point from which the popup should open relative to the iconAnchor
  });

   //35
  var pingpongIcon = L.icon({
    iconUrl: 'images/pingpong50x50.png',    
    iconSize:     [50, 50], // size of the icon
    iconAnchor:   [25, 50], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -50], // point from which the popup should open relative to the iconAnchor
  });

   //36
  var billiardsIcon = L.icon({
    iconUrl: 'images/pool_billiards50x50.png',    
    iconSize:     [50, 50], // size of the icon
    iconAnchor:   [25, 50], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -50], // point from which the popup should open relative to the iconAnchor
  });

   //37
  var badmintonIcon = L.icon({
    iconUrl: 'images/badminton50x50.png',    
    iconSize:     [50, 50], // size of the icon
    iconAnchor:   [25, 50], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -50], // point from which the popup should open relative to the iconAnchor
  });

   //38
  var tennisIcon = L.icon({
    iconUrl: 'images/tennis_50x50.png',    
    iconSize:     [50, 50], // size of the icon
    iconAnchor:   [25, 50], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -50], // point from which the popup should open relative to the iconAnchor
  });

   //39
  var sockerIcon = L.icon({
    iconUrl: 'images/socker_50x50.png',    
    iconSize:     [50, 50], // size of the icon
    iconAnchor:   [25, 50], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -50], // point from which the popup should open relative to the iconAnchor
  });

   //40
  var basketballIcon = L.icon({
    iconUrl: 'images/basketball_50x50.png',    
    iconSize:     [50, 50], // size of the icon
    iconAnchor:   [25, 50], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -50], // point from which the popup should open relative to the iconAnchor
  });

  var icon_type = [{icon: ihereIcon},{icon: scottyIcon},{icon: sexyIcon},{icon: girlIcon}, {icon: short_girlIcon},{icon: skiny_girlIcon},{icon: fat_girlIcon},{icon: lady_boyIcon}, {icon: copIcon},{icon: cop_runingIcon}, {icon: police_truckIcon},{icon: johnIcon},{icon: ihereIcon},{icon: partyIcon},{icon: eatingIcon},{icon: weedIcon},{icon: cameraIcon},{icon: bicycleIcon},{icon: hikeIcon},{icon: rollerbladeIcon},{icon: skateboardIcon},{icon: motorbikeIcon},{icon: harlybikeIcon},{icon: kitesurfIcon},{icon: windsurfIcon},{icon: motorboatIcon},{icon: sailboatIcon},{icon: hangglideIcon},{icon: carIcon},{icon: pickupIcon},{icon: bigtruckIcon},{icon: trainIcon},{icon: remoteIcon},{icon: musicIcon},{icon: chessIcon},{icon: pingpongIcon},{icon: billiardsIcon},{icon: badmintonIcon},{icon: tennisIcon},{icon: sockerIcon},{icon: basketballIcon}];

  function get_site_hostname() {
    var a = document.createElement('a');
    a.href = window.location.href;
   //['href','protocol','host','hostname','port','pathname','search','hash'].forEach(function(k) {
   //  console.log(k+':', a[k]);
   //});
   console.log("site hostname");
   console.log(a['hostname']);
   return a['hostname'];
  } 

  function send_cords(lat, lon, type) {
      var timestamp = Math.floor(Date.now() / 1000);
      //GET /?id=206648&timestamp=1459757028&lat=12.9304184&lon=100.8798106&speed=0.0&bearing=0.0&altitude=0.0&batt=100.0
      if (params.enable_send_cord == 1){
        var url = params.tracker_server + "?id=" + params.id + "&timestamp=" + timestamp + "&lat=" + lat + "&lon=" + lon + "&type=" + type;
        console.log("send_cords");
        console.log("url: " + url);	
        http.open("GET", url, true);
        http.send();
      } else {
        console.log("send_cords disabled");
      }
    }

  function getLocation() {
    if (params.enable_send_cord != 1) {
      console.log("getLocation disabled");
      return;
    }
    if (navigator.geolocation) {
        //navigator.geolocation.watchPosition(showPosition);
        navigator.geolocation.getCurrentPosition(showPosition);
    } else { 
       alert("Geolocation is not supported by this browser.");
    }
  }

  function showPosition(position) {
    console.log("showPosition");
    console.log( position.coords.latitude ); 
    console.log( position.coords.longitude );
    send_cords(position.coords.latitude, position.coords.longitude, 0);
    //alert(" position sent lat: " + position.coords.latitude + " lon: " + position.coords.longitude + " type: " + type + " id: " + id );
  }



  /**
 * Overwrites obj1's values with obj2's and adds obj2's if non existent in obj1
 * @param obj1
 * @param obj2
 * @returns obj3 a new object based on obj1 and obj2
 */
  function merge_options(obj1,obj2){
    var obj3 = {};
    for (var attrname in obj1) { obj3[attrname] = obj1[attrname]; }
    for (var attrname in obj2) { obj3[attrname] = obj2[attrname]; }
    return obj3;
  }

   function clone(obj) {
     if (null == obj || "object" != typeof obj) return obj;
     var copy = obj.constructor();
     for (var attr in obj) {
       if (obj.hasOwnProperty(attr)) copy[attr] = clone(obj[attr]);
     }
     return copy;
   }

   function update_tracks(points) {
     console.log("udate_tracks");
     remove_markers();    
     map.removeLayer(lines);
     mylines2 = [];
     console.log("points");
     console.log(points);
     //var points = data_obj.track;
     var tracks = {};
     var info = "";
     for ( var i = 0; i < points.length; i++) {
       if (typeof tracks[points[i]['id']] == "undefined") {
         tracks[points[i]['id']] = [];
         points[i]['lng'] = points[i]['lon'];
         tracks[points[i]['id']].push(points[i]);
       } else {
         points[i]['lng'] = points[i]['lon'];
         tracks[points[i]['id']].push(points[i]);
       }         
     }
     console.log("tracks")
     console.log(tracks);
     var line = {
       "type": "LineString",
       "coordinates": []
     };
     var track = [];
     var a;
     var chosen_tracks = {};
     console.log("params.track_id");
     console.log(params.track_id);

     if (params.track_id.length > 0) {
       chosen_tracks[params.track_id] = tracks[params.track_id];
     }else {
       chosen_tracks = tracks;
     }
     console.log("chosen_tracks");
     console.log(chosen_tracks); 
     for (var key in chosen_tracks) {          
       track = clone(chosen_tracks[key]);
       line['coordinates'] = [];
       var last_i = 0;
       info = " id: " + chosen_tracks[key][last_i]['id'] + " lat: " +chosen_tracks[key][last_i]['lat']  + " lon: " +chosen_tracks[key][last_i]['lon'] +" last updated: " + timestampToString(chosen_tracks[key][last_i]['timestamp']) + " type: " + chosen_tracks[key][last_i]['type'];
  
       add_marker(chosen_tracks[key][last_i]['lat'],chosen_tracks[key][last_i]['lon'],12,info);     
       for (var i = 0; i < chosen_tracks[key].length; ++i) {
         a = [];
         a.push(chosen_tracks[key][i]['lon']);
         a.push(chosen_tracks[key][i]['lat']);
         line['coordinates'].push(a);
         last_i = i;
       }
       mylines2.push(clone(line));
     }
     console.log("myline2");
     console.log(mylines2)
     lines = L.geoJson(mylines2).addTo(map);
   }

    function write_icons(points) {
      // points is an array
      console.log("points");
      console.log(points);
      var info = "";
      var filter_list;
      var i2;
      var flag_break = true;
      for (var i = 0; i < points.length; i++) {
        info = "";
        if (params.filter.length > 0){
          filter_list = params.filter.split(",");
          console.log("filter list");
          console.log(filter_list);
          for ( i2 = 0; i2 < filter_list.length; i2++) {
            if (points[i]['type'] == filter_list[i2]){
              console.log("match filter with: " + points[i]['type']);
              console.log(filter_list[i2]);
              flag_break = false;
            }
          }
          console.log("flag_break");
          console.log(flag_break);
          if (flag_break) { break; }
        }
        console.log("points[i]");
        console.log(points[i]);
        if (typeof points[i]['info'] == "undefined") {
          points[i]['info'] = "";
        }
        console.log("points[i][username] " + points[i]['username']);
        if (typeof points[i]['username'] != 'undefined'){
           info = "user: " + points[i]['username'] ;
        }
        info = info + " id: " + points[i]['id'] + " " + points[i]['info'];
        if (typeof points[i]['pic_file'] != 'undefined') {                
          info = info + " pic_file: " + points[i]['pic_file'] ;
          pic_url = "../shoot/gallery.php?search=" + points[i]['pic_file'];
          info = info + '<a href="' + pic_url + '">Click to View Pic</a>';
        }
        info = info + " lat: " + points[i]['lat'] + " long: " + points[i]['lon'] +" last updated: " + timestampToString(points[i]['timestamp']) + " type: " + points[i]['type'] ;
        console.log(" info ");
        console.log(info );
        var LamMarker;
        if (points[i]['type'] > 40) { 
          LamMarker  = L.marker([points[i]['lat'],points[i]['lon']])
	  .bindPopup(info);
          markers.push(LamMarker);
          map.addLayer(LamMarker);
        } else { 
          LamMarker = L.marker([points[i]['lat'],points[i]['lon']],icon_type[points[i]['type']])
	  .bindPopup(info);
          markers.push(LamMarker);
          map.addLayer(LamMarker);
        }
        LamMarker.setOpacity(0.50);               
      }
      console.log("markers");
      console.log(markers);
    }

   function add_marker(lat,lon,type,info) {
     var LamMarker;
     if (type > 40 || type < 1) { 
       LamMarker  = L.marker([lat,lon],icon_type[12])
       .bindPopup(info);
       markers.push(LamMarker);
       map.addLayer(LamMarker);
     } else { 
        LamMarker = L.marker([lat,lon],icon_type[type])
	.bindPopup(info);
        markers.push(LamMarker);
        map.addLayer(LamMarker);
     }
     LamMarker.setOpacity(0.80); 
   }

   function remove_markers() {
     for (var i = 0; i < markers.length ; i++ ) {
          map.removeLayer(markers[i]);
       }
     markers = [];
   }


   function update_icons(obj) {
     console.log("update_icons");
        //{"all":[{"users":[{"id":"206648"lat":"12.9304777","lon":"100.8797813","info":"Scotty is a cool dude.","timestamp":"1460871380","type":"1","username":"Scotty"}],"count":"1"}{"pics":[{"id":"986583"lat":"12.9304578","lon":"100.8797595","info":"","timestamp":"1461042969","type":"16","pic_file":"webcam1461042969.jpg"}],"count":"1"}{"data":[{"id":"986583"lat":"12.9304625","lon":"100.879818","info":"","timestamp":"1461031394","type":"12"}],"count":"1"}]}

     console.log("update_icons obj");
     console.log(obj);
     if (typeof obj['all'] != 'undefined'){
       remove_markers();
       console.log("obj[all] != undefined");
       if (typeof obj['all'][0]['users'] != 'undefined'){         
         console.log('obj[all][0][users] != undefined');
         if (obj['all'][0]['users'].length > 0){
            console.log('length > 0');
            write_icons(obj['all'][0]['users']);
         }
       }
       if (typeof obj['all'][1]['pics'] != 'undefined'){
         if (obj['all'][1]['pics'].length > 0){
            write_icons(obj['all'][1]['pics']);
         }
       }
       if (typeof obj['all'][2]['data'] != 'undefined'){
         if (obj['all'][2]['data'].length > 0){
            write_icons(obj['all'][2]['data']); 
         }
       }
     } else {
       if (typeof obj['users'] != 'undefined') {
         if (obj['users'].length > 0){
            console.log("obj.users");
            remove_markers();
            write_icons(obj['users']);
         } 
       } 
       if (typeof obj['pics'] != 'undefined') {     
         if (obj['pics'].length > 0){
            console.log("obj.pics");
            remove_markers();
            write_icons(obj['pics']);
         }
       }
       if (typeof obj['data'] != 'undefined') { 
         if (obj['data'].length > 0){
           console.log("obj.data");
           if (obj['data'][0]['type'] == 0) {
             update_tracks(obj['data']);
           } else {
             remove_markers();
             write_icons(obj['data']); 
           }
         }
       }
     }
   }
  
  // default time 3 sec or 3000
  if (params.update_interval > 1 && params.no_icons == null ){
    // temp disable timer  by commenting out next line       
    var myVar = setInterval(myTimer, (Math.round(params.update_interval * 1000)));
  }

  function myTimer() {    
    //var url_list = [params.tracker_get_server + "/?type=99&extra=1&id=1", params.tracker_get_server + "/?last=1", params.tracker_get_server + "/?count=100&extra=1"];
    var url_list = ["./get_track.php/?mode=all","./get_track.php/?mode=data"];
    var ts = Date.now() /1000 |0;
    // start time of 25 hours ago
    var start = ts - (60* params.track_time_min);
    // start time of 6 hours ago
    //var start = ts - 21600;
    console.log("timestamp: " + ts); 
    url = url_list[url_position];
    url = url + "&start=" + start;
    url = url + "&radius=" + params.radius_filter;
    url = url + "&lat=" + params.lat + "&lon=" + params.lon;
    console.log("url now");
    console.log(url);
    http.open("GET", url, true);
    http.send();
    var d = new Date();
    console.log("timer");
    console.log( d.toLocaleTimeString());
    //if (url_position == 0) {
    //  myLines = [];
    //}
    url_position = url_position + 1;
    if (url_position > url_list.length-1) {
      url_position = 0;
    }

    if ((((ts - last_sent_cords_timestamp ) > params.send_cord_interval) || (last_sent_cords_timestamp == 0)) && params.enable_send_cord == 1) {
      console.log("getting location");
      //send_cords();
      getLocation();
      last_sent_cords_timestamp = ts;
    }  
  }

   http.onreadystatechange = function() {//Call a function when the state changes.
      //console.log("readyState: ");
      //console.log(http.readyState);
      //console.log(http.status);
      if(http.readyState == 4 && http.status == 200) {
         console.log("response: ");
         console.log(http.responseText);
         var obj = JSON.parse(http.responseText);        
         //update_icons(obj);
         update_icons(obj);
      }
    }

  function remove_marker(m) {
       map.removeLayer(m);
  }

  function move_marker(m,lat,lon,info,timestamp) {
    console.log("lon");
    console.log(lon);
    console.log("m");
    console.log(m);
    m._latlng.lat = lat;
    m._latlng.lng = lon;
    m._popup._content = info + " " + timestampToString(timestamp);
    m.update();
  }

  

  function timestampToString(t) {
    if (typeof t == "undefined"){
      return " Unknown";
    }
    var t = new Date( t * 1000 );
    var dt = t.toString();
    return dt;
  }

    

  function randomIntFromInterval(min,max) {
    return Math.floor(Math.random()*(max-min+1)+min);
  }

  function get_config() {
    if (typeof(Storage) !== "undefined") {
       params.id = localStorage.getItem("id");
       params.lat = localStorage.getItem("lat");
       params.lon = localStorage.getItem("lon");
       document.getElementById("gallery_path").innerHTML='<a href="./shoot/gallery.php?lat=' + params.lat + "&lon=" + params.lon + '"> Gallery </a>';
       params.zoom = localStorage.getItem("zoom");
       params.track_id = localStorage.getItem("track_id");
       params.track_time_min = localStorage.getItem("track_time_min");
       params.icon_type = localStorage.getItem("icon_type");
       params.info = localStorage.getItem("info");
       params.tracker_server = localStorage.getItem("tracker_server");
       params.tracker_get_server = localStorage.getItem("tracker_get_server");
       params.update_interval = localStorage.getItem("update_interval");
       params.filter = localStorage.getItem("filter");
       params.radius_filter = localStorage.getItem("radius_filter");
       params.send_cord_interval = localStorage.getItem("send_cord_interval");
       params.enable_send_cord = localStorage.getItem("enable_send_cord");
       params.min_speed_record = localStorage.getItem("min_speed_record");
       params.max_speed_record = localStorage.getItem("max_speed_record");
       console.log("params");
       console.log(params);
       console.log("typeof params.id");
       console.log(typeof params.id);
       console.log(params.id);
       //console.log(params.id);
       if ( params.id == null || params.id.length == 0) {
         console.log("id was undefined will create one");
         params.id = randomIntFromInterval(300000,999000);
         localStorage.setItem("id", params.id);
         localStorage.setItem("lat", 12.93419);
         localStorage.setItem("lon", 100.892515 );
         localStorage.setItem("zoom", 15);
         localStorage.setItem("track_id", 206648);
         localStorage.setItem("track_time_min", 120);
         localStorage.setItem("icon_type", 12);
         localStorage.setItem("info", "");
         localStorage.setItem("tracker_server", "https://www.funtracker.site/record_track.php");
         localStorage.setItem("tracker_get_server", "https://www.funtracker.site/get_track.php");
         localStorage.setItem("update_interval", "3");
         localStorage.setItem("irc_server", "wilhelm.freenode.net");
         localStorage.setItem("cam_resolution", "low");
         localStorage.setItem("filter", "");
         localStorage.setItem("send_cord_interval", "60");
         localStorage.setItem("enable_send_cord", "1");
         localStorage.setItem("min_speed_record", "1");
         localStorage.setItem("max_speed_record", "6");
         // radius_filter is in Meters
         localStorage.setItem("radius_filter", "4000");
         get_config();
       } 
    } else {
       params.id = randomIntFromInterval(300000,999000);
       alert("Sorry, your browser does not support Web Storage, time to upgrade.. your ID now: " + id);       
    }
  }

      if (json_param == null) {
        //get_config();   
      } else {
        if (params.zoom == null) {
          params.zoom = 15;
        }
      }

        

        mapLink = '<a href="https://openstreetmap.org">OpenStreetMap</a>';
        var base = new L.tileLayer(
            'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: ' Openstreetmap.org,  FunTracker.Site',
            maxZoom: 19,
            });
         
          
        var map = new L.Map('map', {
			layers: [base],
                        zoomControl:false,
			fullscreenControl: true,
			fullscreenControlOptions: { // optional
				title:"Show me the fullscreen !",
				titleCancel:"Exit fullscreen mode"
			}
		}).setView([params.lat,params.lon], params.zoom);


      if (json_param != null) {
        if (params.info == null){
          params.info = "";
        }
        console.log("params2");
        console.log(params);
        var pop_info = "Shared by: " + params.id + " " + params.info + " taken at: " + timestampToString(params.timestamp) + " pic_file: " + params.pic_file;
        console.log(params.info + " last updated: " + timestampToString(params.timestamp));
        if (params.icon_type !== null) {
          console.log("type not null");
          L.marker([params.lat,params.lon],icon_type[params.icon_type])
          .bindPopup(pop_info)
	  .addTo(map);
        } else {
          L.marker([params.lat,params.lon],icon_type[0])
          .bindPopup(pop_info)
	  .addTo(map);
        }        
      }

    if (params.no_icons == null){
      console.log("first old icons added");
      //url = params.tracker_get_server + "/?type=99&extra=1&id=1";
      url = "./get_track.php/?mode=all";
      console.log("url");
      console.log(url);
      http.open("GET", url, true);
      http.send();
    }

        
  });
            
               
    </script>
  <style>
.dropbtn {
    background-color: #4CAF50;
    color: white;
    padding: 16px;
    font-size: 16px;
    border: none;
    cursor: pointer;
}

.dropbtn:hover, .dropbtn:focus {
    background-color: #3e8e41;
}

.dropdown {
    position: relative;
    display: inline-block;
}

.dropdown-content {
    display: none;
    position: absolute;
    background-color: #f9f9f9;
    min-width: 160px;
    overflow: auto;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
}

.dropdown-content a {
    color: black;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
}

.dropdown a:hover {background-color: #f1f1f1}

.show {display:block;}
</style>
</body>
</html>

