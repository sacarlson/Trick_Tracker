<!DOCTYPE html>
<html>
<head>
    <title>Real-Time Map</title>
    <meta charset="utf-8" />
    <meta name="keywords" content="real-time, map, track, GPS, proximity alarm, alert, Photos, way points, mark, find friends ">

    <meta name="description" content="A real-time GPS updated Map to display Icon markers, tracked object trails, and picture locations, with added Proximity alert sense. ">

    <link rel="stylesheet" href="w3.css">
    <link rel="stylesheet" href="leaflet.css" />
        
    <style type="text/css">
		#map { width: 700px; height: 433px; }
		.fullscreen-icon { background-image: url(icon-fullscreen.png); }
		/* on selector per rule as explained here : http://www.sitepoint.com/html5-full-screen-api/ */
		#map:-webkit-full-screen { width: 100% ; height: 100% ; z-index: 99999; }
		#map:-moz-full-screen { width: 100% ; height: 100% ; z-index: 99999; }
		#map:full-screen { width: 100% ; height: 100% ; z-index: 99999; }
		.leaflet-pseudo-fullscreen { position: fixed ; width: 100% ; height: 100% ; top: 0px ; left: 0px ; z-index: 99999; }
  .box {
     height: 240px;
     margin: 30px; 
  }

 ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
    overflow: hidden;
    background-color: #333;
 }

li {
    float: left;
}

li a {
    display: block;
    color: white;
    text-align: center;
    padding: 14px 16px;
    text-decoration: none;
}

li a:hover:not(.active) {
    background-color: #111;
}

.active {
    background-color: #4CAF50;
}

li {
    border-right: 3px solid #bbb;
    border-bottom: 3px solid #bbb;
}

a {
  font-size: calc(1.5vw + 1.5vh + 1.5vmin);
 }

	</style>

</head>
<body>
  <div class="w3-row">
    <div class="w3-teal w3-rest">
      <ul>
        <li><a href="send.html">Send Coords</a></li>
        <li><a href="change_icon.html">Change Icon</a></li>
        <li><a href="config.html">Config</a></li>
        <li><a href="./shoot/index.html">Shoot Pic</a></li>
        <li><span id="gallery_path"></span></li>
        <li><a href="./wiki/doku.php">Wiki</a></li>
      </ul>
      <h1><span id="site_hostname"></span> Map</h1>
    </div>
  </div>
  <div class="w3-row">
    <div class="w3-teal w3-rest">
      <div id="map" style="width: 100%; height: 1250px"></div>
    </div>
  </div>
  
        <script src="leaflet.js"></script>
	<script src="Control.FullScreen.js"></script>   

    <script>

    function dropDown() {
      document.getElementById("myDropdown").classList.toggle("show");
    }

  window.addEventListener("load", function(event) {
    console.log("window loaded");
    var url ;

    var http = new XMLHttpRequest();
    var markers = [];
    var markers_data = [];
    var lines = [];
    var myLines = [];
    var last_marker_count = 0;
    var last_data_marker_count = 0;
    var last_lat = 0;
    var last_lon = 0;
    var url_position = 0;
    var timestamp = Math.floor(Date.now() / 1000);
    
    var params = {};
    get_config();
    var json_param = window.location.href.match(/\?json=(.*)/);
    if (json_param != null) {
      json_param = unescape(json_param[1]);
      var params2 = JSON.parse(json_param);
      //params = merge_options(params2,params);
      params = merge_options(params,params2);
    }
    
    console.log("params");
    console.log(params);
    
   var http = new XMLHttpRequest();
   var last_sent_cords_timestamp = 0;

   //var site_hostname = get_site_hostname();
   document.getElementById("site_hostname").innerHTML= get_site_hostname();
   getLocation();

   // preload alarm sound
   var alarm = new Audio();
   alarm.autoplay = false;
   //alarm.src = navigator.userAgent.match(/Firefox/) ? 'shutter.ogg' : 'shutter.mp3';
   alarm.src = 'alarmsiren.mp3';
   //alarm.play();

  function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
      var R = 6371; // Radius of the earth in km
      var dLat = deg2rad(lat2-lat1);  // deg2rad below
      var dLon = deg2rad(lon2-lon1); 
      var a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2)
      ; 
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
      var d = R * c; // Distance in km
      return d;
    }

    function deg2rad(deg) {
      return deg * (Math.PI/180)
    }


  function get_site_hostname() {
    var a = document.createElement('a');
    a.href = window.location.href;
   //['href','protocol','host','hostname','port','pathname','search','hash'].forEach(function(k) {
   //  console.log(k+':', a[k]);
   //});
   console.log("site hostname");
   console.log(a['hostname']);
   return a['hostname'];
  } 

  function send_cords(lat, lon, type) {
      var timestamp = Math.floor(Date.now() / 1000);
      //GET /?id=206648&timestamp=1459757028&lat=12.9304184&lon=100.8798106&speed=0.0&bearing=0.0&altitude=0.0&batt=100.0
      if (params.enable_send_cord == 1){
        var url = params.tracker_server + "?id=" + params.id + "&timestamp=" + timestamp + "&lat=" + lat + "&lon=" + lon + "&type=" + type;
        console.log("send_cords");
        console.log("url: " + url);	
        http.open("GET", url, true);
        http.send();
      } else {
        console.log("send_cords disabled");
      }
    }

  function getLocation() {
    if (params.enable_send_cord != 1) {
      console.log("getLocation disabled");
      return;
    }
    if (navigator.geolocation) {
        //navigator.geolocation.watchPosition(showPosition);
        navigator.geolocation.getCurrentPosition(showPosition);
    } else { 
       alert("Geolocation is not supported by this browser.");
    }
  }

  function showPosition(position) {
    console.log("showPosition");
    console.log( position.coords.latitude ); 
    console.log( position.coords.longitude );
    last_lat = position.coords.latitude;
    last_lon = position.coords.longitude
    send_cords(position.coords.latitude, position.coords.longitude, 0);
    //alert(" position sent lat: " + position.coords.latitude + " lon: " + position.coords.longitude + " type: " + type + " id: " + id );
  }



  /**
 * Overwrites obj1's values with obj2's and adds obj2's if non existent in obj1
 * @param obj1
 * @param obj2
 * @returns obj3 a new object based on obj1 and obj2
 */
  function merge_options(obj1,obj2){
    var obj3 = {};
    for (var attrname in obj1) { obj3[attrname] = obj1[attrname]; }
    for (var attrname in obj2) { obj3[attrname] = obj2[attrname]; }
    return obj3;
  }

   function clone(obj) {
     if (null == obj || "object" != typeof obj) return obj;
     var copy = obj.constructor();
     for (var attr in obj) {
       if (obj.hasOwnProperty(attr)) copy[attr] = clone(obj[attr]);
     }
     return copy;
   }

   function update_tracks(points) {
     console.log("udate_tracks");
     remove_markers();    
     map.removeLayer(lines);
     mylines2 = [];
     console.log("points");
     console.log(points);
     //var points = data_obj.track;
     var tracks = {};
     var info = "";
     for ( var i = 0; i < points.length; i++) {
       if (typeof tracks[points[i]['id']] == "undefined") {
         tracks[points[i]['id']] = [];
         points[i]['lng'] = points[i]['lon'];
         tracks[points[i]['id']].push(points[i]);
       } else {
         points[i]['lng'] = points[i]['lon'];
         tracks[points[i]['id']].push(points[i]);
       }         
     }
     console.log("tracks")
     console.log(tracks);
     var line = {
       "type": "LineString",
       "coordinates": []
     };
     var track = [];
     var a;
     var chosen_tracks = {};
     console.log("params.track_id");
     console.log(params.track_id);

     if (params.track_id.length > 0) {
       chosen_tracks[params.track_id] = tracks[params.track_id];
     }else {
       chosen_tracks = tracks;
     }
     console.log("chosen_tracks");
     console.log(chosen_tracks); 
     for (var key in chosen_tracks) {          
       track = clone(chosen_tracks[key]);
       line['coordinates'] = [];
       var last_i = 0;
       info = " id: " + chosen_tracks[key][last_i]['id'] + " lat: " +chosen_tracks[key][last_i]['lat']  + " lon: " +chosen_tracks[key][last_i]['lon'] +" last updated: " + timestampToString(chosen_tracks[key][last_i]['timestamp']) + " type: " + chosen_tracks[key][last_i]['type'];
  
       add_marker(chosen_tracks[key][last_i]['lat'],chosen_tracks[key][last_i]['lon'],12,info);     
       for (var i = 0; i < chosen_tracks[key].length; ++i) {
         a = [];
         a.push(chosen_tracks[key][i]['lon']);
         a.push(chosen_tracks[key][i]['lat']);
         line['coordinates'].push(a);
         last_i = i;
       }
       mylines2.push(clone(line));
     }
     console.log("myline2");
     console.log(mylines2)
     lines = L.geoJson(mylines2).addTo(map);
   }

    function checkAlarm(lat,lon){
      console.log("checkAlarm");
      if (params.alarm_radius == 0){
        console.log("alarm_radius == 0, disabled");
        return;
      }
      console.log(params.alarm_ref_lat);
      console.log(params.alarm_ref_lon);
      var ref_lat = 0;
      var ref_lon = 0;
      // if params.laarm_ref_lat > 0 then judge distance from alarm_ref_lat,lon else judge distance from last known positon of held device
      if (params.alarm_ref_lat != 0){
         ref_lat = params.alarm_ref_lat;
         ref_lon = params.alarm_ref_lon;
      } else {
         ref_lat = last_lat;
         ref_lon = last_lon;
      }
      var dist_meters = getDistanceFromLatLonInKm(lat,lon,ref_lat,ref_lon) * 1000;
      console.log("dist: " + dist_meters);
      // mode 1  trigger dist > alarm_radius ref lat,lon
      console.log("alarm_radius");
      console.log(params.alarm_radius);
      if (params.alarm_radius > 0){
        console.log("check mode 1");
        if (Math.abs(params.alarm_radius) < dist_meters){
           console.log("sound alarm mode 1");
           alarm.play();
           alert("Proximity Alarm Mode 1 trigered, track_id distance from Map Center > " + params.alarm_radius + " Meters");
           
        }
      } else {
        // mode 2 trigger dist < alarm_radius from you (device you hold)
        if (Math.abs(params.alarm_radius) > dist_meters) {
           console.log("sound alarm mode 2");
           alarm.play();
           alert("Proximity Alarm Mode 2 trigered, track_id distance from Ref lat,lon < " + params.alarm_radius +" Meters");          
        }
      }
    }   


    function write_icons(points,color) {
      // points is an array
      console.log("points");
      console.log(points);
      var info = "";
      var filter_list;
      var i2;
      var flag_break = true;
      for (var i = 0; i < points.length; i++) {
        if (params.alarm_radius != 0 && points[i]['id'] == params.track_id && points[i]['id'] != params.id) {
           checkAlarm(points[i]['lat'],points[i]['lon']);
        }
        info = "";
        if (params.filter.length > 0){
          filter_list = params.filter.split(",");
          console.log("filter list");
          console.log(filter_list);
          for ( i2 = 0; i2 < filter_list.length; i2++) {
            if (points[i]['type'] == filter_list[i2]){
              console.log("match filter with: " + points[i]['type']);
              console.log(filter_list[i2]);
              flag_break = false;
            }
          }
          console.log("flag_break");
          console.log(flag_break);
          if (flag_break) { break; }
        }
        console.log("points[i]");
        console.log(points[i]);
        if (typeof points[i]['info'] == "undefined") {
          points[i]['info'] = "";
        }
        console.log("points[i][username] " + points[i]['username']);
        if (typeof points[i]['username'] != 'undefined'){
           info = "user: " + points[i]['username'] ;
        }
        info = info + " id: " + points[i]['id'] + " " + points[i]['info'];
        if (typeof points[i]['pic_file'] != 'undefined') {                
          info = info + " pic_file: " + points[i]['pic_file'] ;
          pic_url = "../shoot/gallery.php?search=" + points[i]['pic_file'];
          info = info + '<a href="' + pic_url + '">Click to View Pic</a>';
        }
        info = info + " lat: " + points[i]['lat'] + " long: " + points[i]['lon'] +" last updated: " + timestampToString(points[i]['timestamp']) + " type: " + points[i]['type'] ;
        info = "<h2>" + info + "</h2>";
        console.log(" info ");
        console.log(info );
        var LamMarker;
        if (points[i]['type'] > 41) { 
          LamMarker  = L.marker([points[i]['lat'],points[i]['lon']])
	  .bindPopup(info);
          markers.push(LamMarker);
          map.addLayer(LamMarker);
        } else {
          if (points[i]['type'] == 41) {
            console.log("type == 41");
            console.log("params.icon_scale");
            var iconURL = 'uploads/' + points[i]['id'] + '_icon.png';
            console.log(iconURL);
            var custom_icon = L.icon({
              iconUrl: iconURL,    
              iconSize:     [Math.round(57 * params.icon_scale), Math.round(68 * params.icon_scale)], 
              iconAnchor:   [Math.round(28 * params.icon_scale), Math.round(68 * params.icon_scale)], 
              popupAnchor:  [0, Math.round(-69 * params.icon_scale)], 
            });
            LamMarker = L.marker([points[i]['lat'],points[i]['lon']],{icon: custom_icon})
	    .bindPopup(info);
          } else { 
            LamMarker = L.marker([points[i]['lat'],points[i]['lon']],{icon:make_icon(points[i]['type'],color)})
	    .bindPopup(info);
          }
          markers.push(LamMarker);
          map.addLayer(LamMarker);
        }
        if (points[i]['type'] == 41) {
          LamMarker.setOpacity(0.85); 
        } else {
          LamMarker.setOpacity(0.75);
        }              
      }
      console.log("markers");
      console.log(markers);
    }

   function make_icon(type,color) {
     console.log("make_icon");
     var icon_dir = 'images_red';
     if (color == 'green'){
       icon_dir = 'images_green';
     }
     //params.icon_scale
     // Math.round( floatvalue )
     var activeIcon = L.icon({
       iconUrl: icon_dir + '/icon_' + type + '.png',    
       iconSize:     [Math.round(57 * params.icon_scale), Math.round(68 * params.icon_scale)], // size of the icon
       iconAnchor:   [Math.round(28 * params.icon_scale), Math.round(68 * params.icon_scale)], // point of the icon which will correspond to marker's location
       popupAnchor:  [0, Math.round(-69 * params.icon_scale)], // point from which the popup should open relative to the iconAnchor
     });
     return activeIcon;
   }

   function make_icon2(type,color) {
     var icon_dir = 'images_red';
     if (color == 'green'){
       icon_dir = 'images_green';
     }
     //params.icon_scale
     // Math.round( floatvalue )
     var activeIcon = L.icon({
       iconUrl: icon_dir + '/icon_' + type + '.png',    
       iconSize:     [57, 68], // size of the icon
       iconAnchor:   [28, 68], // point of the icon which will correspond to marker's location
       popupAnchor:  [0, -69], // point from which the popup should open relative to the iconAnchor
     });
     return activeIcon;
   }

   function add_marker(lat,lon,type,info) {
     info = "<h2>" + info + "</h2>";
     var LamMarker;
     
     if (type > 41 || type < 1) { 
       LamMarker  = L.marker([lat,lon],{icon:make_icon(12,'red')})
       .bindPopup(info);
       markers.push(LamMarker);
       map.addLayer(LamMarker);
     } else { 
        LamMarker = L.marker([lat,lon],{icon:make_icon(type,'red')})
	.bindPopup(info);
        markers.push(LamMarker);
        map.addLayer(LamMarker);
     }
     LamMarker.setOpacity(0.80); 
   }

   function remove_markers() {
     for (var i = 0; i < markers.length ; i++ ) {
          map.removeLayer(markers[i]);
       }
     markers = [];
   }


   function update_icons(obj) {
     console.log("update_icons");
        //{"all":[{"users":[{"id":"206648"lat":"12.9304777","lon":"100.8797813","info":"Scotty is a cool dude.","timestamp":"1460871380","type":"1","username":"Scotty"}],"count":"1"}{"pics":[{"id":"986583"lat":"12.9304578","lon":"100.8797595","info":"","timestamp":"1461042969","type":"16","pic_file":"webcam1461042969.jpg"}],"count":"1"}{"data":[{"id":"986583"lat":"12.9304625","lon":"100.879818","info":"","timestamp":"1461031394","type":"12"}],"count":"1"}]}

     console.log("update_icons obj");
     console.log(obj);
     if (typeof obj['all'] != 'undefined'){
       remove_markers();
       console.log("obj[all] != undefined");
       if (typeof obj['all'][0]['users'] != 'undefined'){         
         console.log('obj[all][0][users] != undefined');
         if (obj['all'][0]['users'].length > 0){
            console.log('length > 0');
            write_icons(obj['all'][0]['users'],"red");
         }
       }
       if (typeof obj['all'][1]['pics'] != 'undefined'){
         if (obj['all'][1]['pics'].length > 0){
            write_icons(obj['all'][1]['pics'],"green");
         }
       }
       if (typeof obj['all'][2]['data'] != 'undefined'){
         if (obj['all'][2]['data'].length > 0){
            write_icons(obj['all'][2]['data'],"green"); 
         }
       }
     } else {
       if (typeof obj['users'] != 'undefined') {
         if (obj['users'].length > 0){
            console.log("obj.users");
            remove_markers();
            write_icons(obj['users'],"red");
         } 
       } 
       if (typeof obj['pics'] != 'undefined') {     
         if (obj['pics'].length > 0){
            console.log("obj.pics");
            remove_markers();
            write_icons(obj['pics'],"green");
         }
       }
       if (typeof obj['data'] != 'undefined') { 
         if (obj['data'].length > 0){
           console.log("obj.data");
           if (obj['data'][0]['type'] == 0) {
             update_tracks(obj['data']);
           } else {
             remove_markers();
             write_icons(obj['data'],"green"); 
           }
         }
       }
     }
   }
  
  // default time 3 sec or 3000
  if (params.update_interval > 1 && params.no_icons == null ){
    // temp disable timer  by commenting out next line       
    var myVar = setInterval(myTimer, (Math.round(params.update_interval * 1000)));
  }

  function myTimer() {    
    //var url_list = [params.tracker_get_server + "/?type=99&extra=1&id=1", params.tracker_get_server + "/?last=1", params.tracker_get_server + "/?count=100&extra=1"];
    var url_list = ["./get_track.php/?mode=all","./get_track.php/?mode=data"];
    var ts = Date.now() /1000 |0;
    // start time of 25 hours ago
    var start = ts - (60* params.track_time_min);
    // start time of 6 hours ago
    //var start = ts - 21600;
    console.log("timestamp: " + ts); 
    url = url_list[url_position];
    url = url + "&start=" + start;
    url = url + "&radius=" + params.radius_filter;
    url = url + "&lat=" + params.lat + "&lon=" + params.lon;
    console.log("url now");
    console.log(url);
    http.open("GET", url, true);
    http.send();
    var d = new Date();
    console.log("timer");
    console.log( d.toLocaleTimeString());
    //if (url_position == 0) {
    //  myLines = [];
    //}
    url_position = url_position + 1;
    if (url_position > url_list.length-1) {
      url_position = 0;
    }

    if ((((ts - last_sent_cords_timestamp ) > params.send_cord_interval) || (last_sent_cords_timestamp == 0)) && params.enable_send_cord == 1) {
      console.log("getting location");
      //send_cords();
      getLocation();
      last_sent_cords_timestamp = ts;
    }  
  }

   http.onreadystatechange = function() {//Call a function when the state changes.
      //console.log("readyState: ");
      //console.log(http.readyState);
      //console.log(http.status);
      if(http.readyState == 4 && http.status == 200) {
         console.log("response: ");
         console.log(http.responseText);
         var obj = JSON.parse(http.responseText);        
         //update_icons(obj);
         update_icons(obj);
      }
    }

  function remove_marker(m) {
       map.removeLayer(m);
  }

  function move_marker(m,lat,lon,info,timestamp) {
    console.log("lon");
    console.log(lon);
    console.log("m");
    console.log(m);
    m._latlng.lat = lat;
    m._latlng.lng = lon;
    m._popup._content = info + " " + timestampToString(timestamp);
    m.update();
  }

  

  function timestampToString(t) {
    if (typeof t == "undefined"){
      return " Unknown";
    }
    var t = new Date( t * 1000 );
    var dt = t.toString();
    return dt;
  }

    

  function randomIntFromInterval(min,max) {
    return Math.floor(Math.random()*(max-min+1)+min);
  }

  function get_config() {
    if (typeof(Storage) !== "undefined") {
       params.id = localStorage.getItem("id");
       params.lat = localStorage.getItem("lat");
       params.lon = localStorage.getItem("lon");
       document.getElementById("gallery_path").innerHTML='<a href="./shoot/gallery.php?lat=' + params.lat + "&lon=" + params.lon + '"> Gallery </a>';
       params.zoom = localStorage.getItem("zoom");
       params.track_id = localStorage.getItem("track_id");
       params.track_time_min = localStorage.getItem("track_time_min");
       params.icon_type = localStorage.getItem("icon_type");
       params.info = localStorage.getItem("info");
       params.tracker_server = localStorage.getItem("tracker_server");
       params.tracker_get_server = localStorage.getItem("tracker_get_server");
       params.update_interval = localStorage.getItem("update_interval");
       params.filter = localStorage.getItem("filter");
       params.radius_filter = localStorage.getItem("radius_filter");
       params.send_cord_interval = localStorage.getItem("send_cord_interval");
       params.enable_send_cord = localStorage.getItem("enable_send_cord");
       params.min_speed_record = localStorage.getItem("min_speed_record");
       params.max_speed_record = localStorage.getItem("max_speed_record");
       params.icon_scale = localStorage.getItem("icon_scale");
       params.alarm_radius = localStorage.getItem("alarm_radius");
       params.alarm_ref_lat = localStorage.getItem("alarm_ref_lat");
       params.alarm_ref_lon = localStorage.getItem("alarm_ref_lon");
       if ((params.alarm_ref_lat == null) || ( params.alarm_ref_lat.length == 0)) {
         console.log("set default alarm_ref_lat");
         // 0 sets ref lat,lon to device location
         localStorage.setItem("alarm_ref_lat", "0");
         params.alarm_ref_lat = "0";
       }
       if ((params.alarm_ref_lon == null) || ( params.alarm_ref_lon.length == 0)) {
         console.log("set default alarm_ref_lon");
         localStorage.setItem("alarm_ref_lon", "0");
         params.alarm_ref_lon = "0";
       }
       if ((params.alarm_radius == null) || ( params.alarm_radius.length == 0)) {
         console.log("set default alarm_radius");
         // 0 disables alarm
         localStorage.setItem("alarm_radius", "0");
         params.alarm_radius = "0";
       }
       if ((params.icon_scale == null) || ( params.icon_scale.length == 0)) {
         console.log("set default icon_scale");
         localStorage.setItem("icon_scale", "1");
         params.icon_scale = "1";
       }
       console.log("params");
       console.log(params);
       console.log("typeof params.id");
       console.log(typeof params.id);
       console.log(params.id);
       //console.log(params.id);
       if ( params.id == null || params.id.length == 0) {
         console.log("id was undefined will create one");
         params.id = randomIntFromInterval(300000,999000);
         localStorage.setItem("id", params.id);
         localStorage.setItem("lat", 12.93419);
         localStorage.setItem("lon", 100.892515 );
         localStorage.setItem("zoom", 15);
         localStorage.setItem("track_id", 206648);
         localStorage.setItem("track_time_min", 120);
         localStorage.setItem("icon_type", 12);
         localStorage.setItem("info", "");
         localStorage.setItem("tracker_server", "https://www.funtracker.site/record_track.php");
         localStorage.setItem("tracker_get_server", "https://www.funtracker.site/get_track.php");
         localStorage.setItem("update_interval", "3");
         localStorage.setItem("irc_server", "wilhelm.freenode.net");
         localStorage.setItem("cam_resolution", "low");
         localStorage.setItem("filter", "");
         localStorage.setItem("send_cord_interval", "60");
         localStorage.setItem("enable_send_cord", "1");
         localStorage.setItem("min_speed_record", "0.2");
         localStorage.setItem("max_speed_record", "9");
         // radius_filter is in Meters
         localStorage.setItem("radius_filter", "4000");
         get_config();
       } 
    } else {
       params.id = randomIntFromInterval(300000,999000);
       alert("Sorry, your browser does not support Web Storage, time to upgrade.. your ID now: " + id);       
    }
  }

      if (json_param == null) {
        //get_config();   
      } else {
        if (params.zoom == null) {
          params.zoom = 15;
        }
      }

        

        mapLink = '<a href="https://openstreetmap.org">OpenStreetMap</a>';
        var base = new L.tileLayer(
            'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: ' Openstreetmap.org,  FunTracker.Site',
            maxZoom: 19,
            });
         
          
        var map = new L.Map('map', {
			layers: [base],
                        zoomControl:false,
			fullscreenControl: true,
			fullscreenControlOptions: { // optional
				title:"Show me the fullscreen !",
				titleCancel:"Exit fullscreen mode"
			}
		}).setView([params.lat,params.lon], params.zoom);


      if (json_param != null) {
        if (params.info == null){
          params.info = "";
        }
        console.log("params2");
        console.log(params);
        var pop_info = "";
        if (params.icon_type == 16){
          pop_info = "Shared by: " + params.id + " " + params.info + " taken at: " + timestampToString(params.timestamp) + " pic_file: " + params.pic_file;
        } else {
          pop_info = "ID: " + params.id + " User Name: " + params.username + " " + params.info + " updated at: " + timestampToString(params.timestamp);
        }
           
        console.log(params.info + " last updated: " + timestampToString(params.timestamp));
        pop_info = "<h2>" + pop_info + "</h2>";
        if (params.icon_type !== null) {
          console.log("type not null");
          make_icon(params.icon_type,'green')
          L.marker([params.lat,params.lon],{icon:make_icon(params.icon_type,'green')})
          .bindPopup(pop_info)
	  .addTo(map);
        } else {
          L.marker([params.lat,params.lon],{icon:make_icon(12,'green')})
          .bindPopup(pop_info)
	  .addTo(map);
        }        
      }

    if (params.no_icons == null){
      console.log("first old icons added");
      //url = params.tracker_get_server + "/?type=99&extra=1&id=1";
      url = "./get_track.php/?mode=all";
      console.log("url");
      console.log(url);
      http.open("GET", url, true);
      http.send();
    }

        
  });
            
               
    </script>
  <style>
.dropbtn {
    background-color: #4CAF50;
    color: white;
    padding: 16px;
    font-size: 16px;
    border: none;
    cursor: pointer;
}

.dropbtn:hover, .dropbtn:focus {
    background-color: #3e8e41;
}

.dropdown {
    position: relative;
    display: inline-block;
}

.dropdown-content {
    display: none;
    position: absolute;
    background-color: #f9f9f9;
    min-width: 160px;
    overflow: auto;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
}

.dropdown-content a {
    color: black;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
}

.dropdown a:hover {background-color: #f1f1f1}

.show {display:block;}
</style>
</body>
</html>

