<!DOCTYPE html>
<html>
<head>
    <title>Trick Traker Map</title>
    <meta charset="utf-8" />
     
    <link rel="stylesheet" href="w3.css">
    <link rel="stylesheet" href="leaflet.css" />
        
    <style type="text/css">
		#map { width: 700px; height: 433px; }
		.fullscreen-icon { background-image: url(icon-fullscreen.png); }
		/* on selector per rule as explained here : http://www.sitepoint.com/html5-full-screen-api/ */
		#map:-webkit-full-screen { width: 100% ; height: 100% ; z-index: 99999; }
		#map:-moz-full-screen { width: 100% ; height: 100% ; z-index: 99999; }
		#map:full-screen { width: 100% ; height: 100% ; z-index: 99999; }
		.leaflet-pseudo-fullscreen { position: fixed ; width: 100% ; height: 100% ; top: 0px ; left: 0px ; z-index: 99999; }
  .box {
     height: 230px;
     margin: 30px; 
  }

 ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
    overflow: hidden;
    background-color: #333;
}

li {
    float: left;
}

li a {
    display: block;
    color: white;
    text-align: center;
    padding: 14px 16px;
    text-decoration: none;
}

li a:hover:not(.active) {
    background-color: #111;
}

.active {
    background-color: #4CAF50;
}

li {
    border-right: 3px solid #bbb;
    border-bottom: 3px solid #bbb;
}

a {
  font-size: calc(1.5vw + 1.5vh + 1.5vmin);
 }



	</style>
</head>
<body>
    <div class="box">
  <ul>
  <li><a href="send.html">Send Cords</a></li>
  <li><a href="http://news.tricktraker.com/">News</a></li>
  <li><a href="config.html">Config</a></li>
  <li><a href="./shoot/index.html">Shoot Pic</a></li>
  <li><a href="./shoot/gallery.php">Gallery</a></li>
  <li><a href="chat.html">Real Time Chat</a></li>
</ul>
  <h1>Trick Traker Map</h1>
</div>
    <div id="map" style="width: 100%; height: 800px"></div>

  
        <script src="leaflet.js"></script>
	<script src="Control.FullScreen.js"></script>   

    <script>

    function dropDown() {
      document.getElementById("myDropdown").classList.toggle("show");
    }

  window.addEventListener("load", function(event) {
    var url ;

    var http = new XMLHttpRequest();
    var markers = [];
    var markers_data = [];
    var lines = [];
    var myLines = [];
    var last_marker_count = 0;
    var last_data_marker_count = 0;
    var url_position = 0;
    var timestamp = Math.floor(Date.now() / 1000);
    
    var params = {};
    get_config();
    var json_param = window.location.href.match(/\?json=(.*)/);
    if (json_param != null) {
      json_param = unescape(json_param[1]);
      var params2 = JSON.parse(json_param);
      //params = merge_options(params2,params);
      params = merge_options(params,params2);
    }
    
    console.log("params");
    console.log(params);
    

   var scottyIcon = L.icon({
    iconUrl: 'scotty_map_icon75x75.png',    
    iconSize:     [75, 75], // size of the icon
    iconAnchor:   [37, 75], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -77], // point from which the popup should open relative to the iconAnchor
  });
 

  var cop_runingIcon = L.icon({
    iconUrl: 'running_cop_50x61.png',
    iconSize:     [50, 61], // size of the icon
    iconAnchor:   [25, 61], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -76] // point from which the popup should open relative to the iconAnchor
  });

  var copIcon = L.icon({
    iconUrl: 'police_standing_25x94.png',
    iconSize:     [25, 94], // size of the icon
    iconAnchor:   [17, 61], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -96] // point from which the popup should open relative to the iconAnchor
  });

  var johnIcon = L.icon({
    iconUrl: 'man_with_money_49x61.png',
    iconSize:     [49, 61], // size of the icon
    iconAnchor:   [25, 61], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -64] // point from which the popup should open relative to the iconAnchor
  });

  var fat_girlIcon = L.icon({
    iconUrl: 'fat_girl_47x60.png',
    iconSize:     [47, 60], // size of the icon
    iconAnchor:   [25, 60], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -65] // point from which the popup should open relative to the iconAnchor
  });

  var police_truckIcon = L.icon({
    iconUrl: 'police_truck_60x23.png',
    iconSize:     [60, 23], // size of the icon
    iconAnchor:   [30, 23], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -25] // point from which the popup should open relative to the iconAnchor
  });

  var girlIcon = L.icon({
    iconUrl: 'nice_girl_21x62.png',
    iconSize:     [21, 62], // size of the icon
    iconAnchor:   [10, 62], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -65] // point from which the popup should open relative to the iconAnchor
  });

  var sexyIcon = L.icon({
    iconUrl: 'sexy_girl_20x60.png',
    iconSize:     [20, 60], // size of the icon
    iconAnchor:   [10, 60], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -65] // point from which the popup should open relative to the iconAnchor
  });

  var ihereIcon = L.icon({
    iconUrl: 'Im_here45x60.png',    
    iconSize:     [45, 60], // size of the icon
    iconAnchor:   [22, 60], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -65], // point from which the popup should open relative to the iconAnchor
  });

  var skiny_girlIcon = L.icon({
    iconUrl: 'skiny_no_tits_18x60.png',    
    iconSize:     [18, 60], // size of the icon
    iconAnchor:   [9, 60], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -65], // point from which the popup should open relative to the iconAnchor
  });

  var lady_boyIcon = L.icon({
    iconUrl: 'lady_boy_39x61.png',    
    iconSize:     [39, 61], // size of the icon
    iconAnchor:   [19, 61], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -65], // point from which the popup should open relative to the iconAnchor
  });

  var short_girlIcon = L.icon({
    iconUrl: 'short_girl_18x40.png',    
    iconSize:     [18, 40], // size of the icon
    iconAnchor:   [9, 40], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -45], // point from which the popup should open relative to the iconAnchor
  });

  // icon 13
  var partyIcon = L.icon({
    iconUrl: 'beer_party60x48.png',    
    iconSize:     [60, 48], // size of the icon
    iconAnchor:   [30, 24], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -50], // point from which the popup should open relative to the iconAnchor
  });

  // icon 14
  var eatingIcon = L.icon({
    iconUrl: 'eat_food47x60.png',    
    iconSize:     [47, 60], // size of the icon
    iconAnchor:   [23, 24], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -50], // point from which the popup should open relative to the iconAnchor
  });

  //icon 15
  var weedIcon = L.icon({
    iconUrl: 'weed_icon41x61.png',    
    iconSize:     [41, 61], // size of the icon
    iconAnchor:   [20, 61], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -62], // point from which the popup should open relative to the iconAnchor
  });

  //icon 16
  var cameraIcon = L.icon({
    iconUrl: 'camera60x48.png',    
    iconSize:     [60, 48], // size of the icon
    iconAnchor:   [30, 48], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -50], // point from which the popup should open relative to the iconAnchor
  });
	

  var icon_type = [{icon: ihereIcon},{icon: scottyIcon},{icon: sexyIcon},{icon: girlIcon}, {icon: short_girlIcon},{icon: skiny_girlIcon},{icon: fat_girlIcon},{icon: lady_boyIcon}, {icon: copIcon},{icon: cop_runingIcon}, {icon: police_truckIcon},{icon: johnIcon},{icon: ihereIcon},{icon: partyIcon},{icon: eatingIcon},{icon: weedIcon},{icon: cameraIcon}];


  /**
 * Overwrites obj1's values with obj2's and adds obj2's if non existent in obj1
 * @param obj1
 * @param obj2
 * @returns obj3 a new object based on obj1 and obj2
 */
  function merge_options(obj1,obj2){
    var obj3 = {};
    for (var attrname in obj1) { obj3[attrname] = obj1[attrname]; }
    for (var attrname in obj2) { obj3[attrname] = obj2[attrname]; }
    return obj3;
  }


   function update_tracks(data_obj) {
     console.log("udate_tracks");
     if (data_obj.id == 0) {
       console.log("data_obj.id == 0");
     }
     map.removeLayer(lines);
     mylines2 = [];
     console.log("update_tracks");
     console.log("data_obj");
     console.log(data_obj);
     var points = data_obj.track;
     var tracks = {};
     for ( var i = 0; i < points.length; i++) {
       if (typeof tracks[points[i]['id']] == "undefined") {
         tracks[points[i]['id']] = [];
         points[i]['lng'] = points[i]['lon'];
         tracks[points[i]['id']].push(points[i]);
       } else {
         points[i]['lng'] = points[i]['lon'];
         tracks[points[i]['id']].push(points[i]);
       }         
     }
     console.log("tracks")
     console.log(tracks);
     var line = {
       "type": "LineString",
       "coordinates": []
     };
     var track = [];
     var a;
     var chosen_tracks = {};
     console.log("params.track_id");
     console.log(params.track_id);

     if (params.track_id.length > 0) {
       chosen_tracks[params.track_id] = tracks[params.track_id];
     }else {
       chosen_tracks = tracks;
     }
     console.log("chosen_tracks");
     console.log(chosen_tracks); 
     for (var key in chosen_tracks) {          
       track = clone(chosen_tracks[key]);
       line['coordinates'] = [];       
       for (var i = 0; i < chosen_tracks[key].length; ++i) {
         a = [];
         a.push(chosen_tracks[key][i]['lon']);
         a.push(chosen_tracks[key][i]['lat']);
         line['coordinates'].push(a);
       }
       mylines2.push(clone(line));
     }
     console.log("myline2");
     console.log(mylines2)
     lines = L.geoJson(mylines2).addTo(map);
     console.log(lines);
   }

   function clone(obj) {
     if (null == obj || "object" != typeof obj) return obj;
     var copy = obj.constructor();
     for (var attr in obj) {
       if (obj.hasOwnProperty(attr)) copy[attr] = clone(obj[attr]);
     }
     return copy;
   }

   function update_icons(user_obj) {
     console.log("update_icons");
     //{"id":"0","track":[{"lat":"13.8994973","lon":"100.5426442","timestamp":"1460102406","speed":"0","bearing":"0","alt":"0","id":"986007","comment":"","type":"2"},{"lat":"13.8994973","lon":"100.5426442","timestamp":"1460101117","speed":"0","bearing":"0","alt":"0","id":"986007","comment":"","type":"2"},{"lat":"13.8994973","lon":"100.5426442","timestamp":"1460096130","speed":"0","bearing":"0","alt":"0","id":"986007","comment":"","type":"2"}],"count":"3"}
     //var icon_type = [{icon: ihereIcon},{icon: scottyIcon},{icon: sexyIcon},{icon: girlIcon}, {icon: short_girlIcon},{icon: skiny_girlIcon},{icon: fat_girlIcon},{icon: lady_boyIcon}, {icon: copIcon},{icon: cop_runingIcon}, {icon: police_truckIcon},{icon: johnIcon}];
    console.log("user_obj");
    console.log(user_obj);
    //if (user_obj.id == '206648') {
    if (typeof user_obj.track != 'undefined') {
      console.log("not undefined: " + user_obj.track );
      if (user_obj.id != 1){
        console.log("id not 1 to update_tracks");
        update_tracks(user_obj);
        return;
      }
    }
    var points ;
    var info ;
    if (user_obj.id == 1){
       points = user_obj.track;
       //markers_data
       for (var i = 0; i < last_data_marker_count; i++ ) {
          map.removeLayer(markers_data[i]);
       }
       last_data_marker_count = points.length;
          
    } else {
       points = user_obj.users;
       for (var i = 0; i < last_marker_count; i++ ) {
          map.removeLayer(markers[i]);
       } 
       last_marker_count = points.length;
       //console.log("remove lines");
       //map.removeLayer(lines); 
    }
       

    for ( i = 0; i < points.length; i++) {
        if (typeof points[i]['info'] == "undefined") {
          points[i]['info'] = "";
        }
        if (user_obj.id == 0){
          console.log("id = 0");               
          info = "id: " + points[i]['id'] + " " + points[i]['info'];
          console.log("bindPopup");
          console.log(info + " last updated: " + timestampToString(points[i]['timestamp']));
          if (points[i]['type'] > 14) { 
            markers_data[i] = L.marker([points[i]['lat'],points[i]['lon']])
	    .bindPopup(info + " last updated: " + timestampToString(points[i]['timestamp']))
	    .addTo(map);
          } else { 
            markers_data[i] = L.marker([points[i]['lat'],points[i]['lon']],icon_type[points[i]['type']])
	    .bindPopup(info + " last updated: " + timestampToString(points[i]['timestamp']))
	    .addTo(map);
          }
          markers_data[i].setOpacity(0.60);  
        } else {
          info = "user: " + points[i]['username'] + " " + points[i]['info'];
          console.log("bindPopup");
          console.log(info + " last updated: " + timestampToString(points[i]['timestamp']));
          // if type > 16 then we will go with default icon type 
          if (points[i]['type'] > 16) {
            console.log("type > 16"); 
            markers[i] = L.marker([points[i]['lat'],points[i]['lon']])
            .bindPopup(info + " last updated: " + timestampToString(points[i]['timestamp']))
	    .addTo(map);
            
          } else { 
            console.log("points points[i]['type']");
            console.log(points[i]['type']);
            console.log(points);
            console.log(i);
            markers[i] = L.marker([points[i]['lat'],points[i]['lon']],icon_type[points[i]['type']])
            .bindPopup(info + " last updated: " + timestampToString(points[i]['timestamp']))
	    .addTo(map);
            
          } 
          markers[i].setOpacity(0.60);        
        }       
      }
      console.log("markers");
      console.log(markers);
   }

  
  // default time 20 sec or 20000
  if (params.update_interval > 1){         
    var myVar = setInterval(myTimer, (Math.round(params.update_interval * 1000)));
  }

  function myTimer() {
    
    var url_list = [params.tracker_get_server + "/?type=99&extra=1&id=1", params.tracker_get_server + "/?last=1", params.tracker_get_server + "/?count=100&extra=1"];
    var ts = Date.now() /1000 |0;
    // start time of 25 hours ago
    var start = ts - (60* params.track_time_min);
    // start time of 6 hours ago
    //var start = ts - 21600;
    console.log("timestamp: " + ts); 
    url = url_list[url_position];
    url = url + "&start=" + start
    console.log("url now");
    console.log(url);
    http.open("GET", url, true);
    http.send();
    var d = new Date();
    console.log("timer");
    console.log( d.toLocaleTimeString());
    //if (url_position == 0) {
    //  myLines = [];
    //}
    url_position = url_position + 1;
    if (url_position > url_list.length-1) {
      url_position = 0;
    }
  }

   http.onreadystatechange = function() {//Call a function when the state changes.
      //console.log("readyState: ");
      //console.log(http.readyState);
      //console.log(http.status);
      if(http.readyState == 4 && http.status == 200) {
         console.log("response: ");
         console.log(http.responseText);
         var obj = JSON.parse(http.responseText);        
         //update_icons(obj);
         update_icons(obj);
      }
    }

  function remove_marker(m) {
       map.removeLayer(m);
  }

  function move_marker(m,lat,lon,info,timestamp) {
    console.log("lon");
    console.log(lon);
    console.log("m");
    console.log(m);
    m._latlng.lat = lat;
    m._latlng.lng = lon;
    m._popup._content = info + " " + timestampToString(timestamp);
    m.update();
  }

  

  function timestampToString(t) {
    if (typeof t == "undefined"){
      return " Unknown";
    }
    var t = new Date( t * 1000 );
    var dt = t.toString();
    return dt;
  }

    

  function randomIntFromInterval(min,max) {
    return Math.floor(Math.random()*(max-min+1)+min);
  }

  function get_config() {
    if (typeof(Storage) !== "undefined") {
       params.id = localStorage.getItem("id");
       params.lat = localStorage.getItem("lat");
       params.lon = localStorage.getItem("lon");
       params.zoom = localStorage.getItem("zoom");
       params.track_id = localStorage.getItem("track_id");
       params.track_time_min = localStorage.getItem("track_time_min");
       params.icon_type = localStorage.getItem("icon_type");
       params.info = localStorage.getItem("info");
       params.tracker_server = localStorage.getItem("tracker_server");
       params.tracker_get_server = localStorage.getItem("tracker_get_server");
       params.update_interval = localStorage.getItem("update_interval");
       console.log("params");
       console.log(params);
       console.log("typeof params.id");
       console.log(typeof params.id);
       console.log(params.id);
       //console.log(params.id);
       if ( params.id == null || params.id.length == 0) {
         console.log("id was undefined will create one");
         params.id = randomIntFromInterval(300000,999000);
         localStorage.setItem("id", params.id);
         localStorage.setItem("lat", 12.93419);
         localStorage.setItem("lon", 100.892515 );
         localStorage.setItem("zoom", 15);
         localStorage.setItem("track_id", 206648);
         localStorage.setItem("track_time_min", 120);
         localStorage.setItem("icon_type", 0);
         localStorage.setItem("info", "");
         localStorage.setItem("tracker_server", "https://www.tricktraker.com/track.php");
         localStorage.setItem("tracker_get_server", "https://www.tricktraker.com/get_track.php");
         localStorage.setItem("update_interval", "3");
         localStorage.setItem("irc_server", "wilhelm.freenode.net");
         localStorage.setItem("cam_resolution", "low");
         get_config();
       } 
    } else {
       params.id = randomIntFromInterval(300000,999000);
       alert("Sorry, your browser does not support Web Storage, time to upgrade.. your ID now: " + id);       
    }
  }

      if (json_param == null) {
        //get_config();   
      } else {
        if (params.zoom == null) {
          params.zoom = 15;
        }
      }

        

        mapLink = '<a href="https://openstreetmap.org">OpenStreetMap</a>';
        var base = new L.tileLayer(
            'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; ' + mapLink + ' Contributors, Trick Traker',
            maxZoom: 19,
            });
         
          
        var map = new L.Map('map', {
			layers: [base],
                        zoomControl:false,
			fullscreenControl: true,
			fullscreenControlOptions: { // optional
				title:"Show me the fullscreen !",
				titleCancel:"Exit fullscreen mode"
			}
		}).setView([params.lat,params.lon], params.zoom);


      if (json_param != null) {
        if (params.info == null){
          params.info = "";
        }
        console.log("params2");
        console.log(params);
        var pop_info = "Shared by: " + params.id + " " + params.info + " taken at: " + timestampToString(params.timestamp) + " pic_file: " + params.pic_file;
        console.log(params.info + " last updated: " + timestampToString(params.timestamp));
        if (params.icon_type !== null) {
          console.log("type not null");
          L.marker([params.lat,params.lon],icon_type[params.icon_type])
          .bindPopup(pop_info)
	  .addTo(map);
        } else {
          L.marker([params.lat,params.lon],icon_type[0])
          .bindPopup(pop_info)
	  .addTo(map);
        }        
      }


    url = params.tracker_get_server + "/?type=99&extra=1&id=1"
    console.log("url");
    console.log(url);
    http.open("GET", url, true);
    http.send();

        
  });
            
               
    </script>
  <style>
.dropbtn {
    background-color: #4CAF50;
    color: white;
    padding: 16px;
    font-size: 16px;
    border: none;
    cursor: pointer;
}

.dropbtn:hover, .dropbtn:focus {
    background-color: #3e8e41;
}

.dropdown {
    position: relative;
    display: inline-block;
}

.dropdown-content {
    display: none;
    position: absolute;
    background-color: #f9f9f9;
    min-width: 160px;
    overflow: auto;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
}

.dropdown-content a {
    color: black;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
}

.dropdown a:hover {background-color: #f1f1f1}

.show {display:block;}
</style>
</body>
</html>

